# Modules → ERP security compliance gaps (actionable table)

Summary
- This table lists missing features or controls (derived from ERP-Security-Implementation.pdf) per module.
- Each row includes severity, where to change (file path), and a short remediation note — keep changes simple and opt-in where appropriate.

| Module | Missing / recommended items (short) | Severity | Files / locations to update | Suggested minimal change (one-line) |
|---|---:|---:|---|---|
| AKS-Private-Cluster | Enable cluster audit & control plane logs; enable Container Insights; enforce pod / network policies; enable AKS-managed AAD / RBAC and enable Azure Defender for K8s; node auto-upgrade/auto-repair | Critical | modules/AKS-Private-Cluster/* (aks.tf, data.tf, variables.tf, output.tf) | Add variables for monitoring, managed_aad, network_policy, defender=true; enable azurerm_kubernetes_cluster addon_profile and enable_msi_identity and monitoring addon. |
| App-Gateway | TLS minimum policy, force HTTPS redirect, client auth / WAF rules centralization, logging to central Diagnostics | High | modules/App-Gateway/* (app_gateway.tf, waf_policy.tf, variables.tf) | Add TLS policy variables, add HTTPS redirect configuration, ensure WAF policy exists and diagnostics are managed centrally (remove any inline diag resources). |
| Azure-Container-Registries | Disable admin user by default; recommend ACR retention/purge & content-trust alternatives; integrate with central Diagnostic-Settings; optionally enable ACR CMK using Key Vault (opt-in) | High | modules/Azure-Container-Registries/* (acr.tf, variables.tf, output.tf) | Ensure admin_enabled defaults to false, keep CMK variables optional; remove inline diag settings (use central module). |
| Azure-Firewall | Ensure diagnostic logging to central workspace, threat-intel, logging retention, NAT/Network rules hardening, HA config checking | High | modules/Azure-Firewall/* (main.tf, firewall_policy.tf, variables.tf) | Add variables for diag enablement, threat_intel_mode, ensure logs not hardcoded and can be pushed through Diagnostic-Settings module. |
| Azure-Frontdoor | WAF integration, logging/diagnostics, ensure TLS policy and secure headers, rate-limits/ratelimit rules | High | modules/Azure-Frontdoor/* (AFD_*.tf, variables.tf) | Add variables for waf_policy_id, tls_min_version and central diagnostics targets. |
| Azure-Private-Endpoints | Ensure private DNS links, outputs for private_dns_zone_ids, controlled NSG, monitoring | Medium | modules/Azure-Private-Endpoints/* (private_endpoint.tf, variables.tf, output.tf) | Add optional VNet link variables and export private_dns_zone_id outputs; keep diag via central module. |
| Diagnostic-Settings | Must be able to target all resource types, support log categories and metrics lists, multiple sinks (LA / storage / eventhub), retention handling | Critical | modules/Diagnostic-Settings/* (diagnostic_settings.tf, variables.tf) | Add support for dynamic log categories and multiple optional sinks; keep opt-in. |
| Key-Vaults | Ensure purge protection + soft-delete, RBAC-based access recommended, private endpoint option, diagnostics, key rotation policies | Critical | modules/Key-Vaults/* (key_vault.tf, access_policy.tf, variables.tf) | Set soft_delete_retention_days + soft_delete_enabled + purge_protection; add network_acls and user-assigned identity optional variables. |
| Linux-Virtual-Machines | Disk encryption (CMK) opt-in, boot diagnostics + monitoring agent, vulnerability assessment/antimalware extension, backup plan, secure boot where supported | High | modules/Linux-Virtual-Machines/* (vms.tf, variables.tf, nsg.tf, nic.tf) | Add variables to enable CMK for OS/data disks, enable diagnostic agent/extension and auto-patching, and keep extensions optional. |
| Windows-Virtual-Machines | Same as Linux: CMK disk encryption opt-in, boot diagnostics, extensions for Defender, patching settings, secure admin / password policy | High | modules/Windows-Virtual-Machines/* (vms.tf, variables.tf, nsg.tf) | Add optional extensions and CMK/disk_encryption options; enable boot diagnostics. |
| Log-Analytics-Workspace | Retention policy, resource locking, diagnostic export, cost tier / workspace cap flags | Medium | modules/Log-Analytics-Workspace/* (log_analytics.tf, variables.tf) | Add optional retention days variable, lock management guidance, and enforce private link or restrictions. |
| PostgreSQL-Flexible-Server | Enforce SSL, backup retention settings, diagnostic log streaming, private network + firewall rules, encryption with CMKs | Critical | modules/PostgreSQL-Flexible-Server/* (main.tf, variables.tf) | Add enforce_ssl variable, backup_retention_days and option to use private_service_access/private endpoint and CMK. |
| Private-DNS-Zone | Ensure VNet links created with proper scope, export link_ids for cross-module wiring, diagnostics | Low | modules/Private-DNS-Zone/* (main.tf, output.tf) | Expose vnet_link outputs and add variable for automatic vnet links. |
| RG | Apply resource locks, tag enforcement, least privilege role assignments, auditing | Medium | modules/RG/* (RG.tf, variables.tf) | Provide optional tag validation variables, create option to apply resource locks via a variable. |
| Storage-Accounts | secure_transfer_required, min_tls_version, disable_public_access, blob soft-delete, lifecycle management, CMK encryption option, network rules | Critical | modules/Storage-Accounts/* (storage_accounts.tf, variables.tf) | Ensure secure_transfer_required = true, min_tls_version = "TLS1_2", disable blob public access, add lifecycle and CMK backfill options; centralize diagnostics. |
| Vnet | Subnet segmentation guidance (hub/spoke), DDoS protection, service endpoints, NSG enforcement patterns | Medium | modules/Vnet/* (main.tf, variables.tf) | Add optional ddos_protection_plan_id, tagging conventions, and subnet-level NSG outputs to wire patterns. |
| Vnet-peering | Ensure 'allow_forwarded_traffic', 'allow_gateway_transit', 'use_remote_gateways' settings and route control | Low | modules/Vnet-peering/* (peering.tf, variables.tf) | Add variables to set peering properties explicitly and export route table references. |

Notes / next steps
- Priority: enforce Critical items first (Key Vault, Diagnostics, Container Registry secured, PostgreSQL, Storage).
- Keep all changes opt-in via variables — do not force unsafe defaults into production.
- Centralize diagnostics using modules/Diagnostic-Settings; remove per-module diag resources and expose target resource id outputs (e.g., xxx_id).
- Consider adding a per-module examples/ folder demonstrating how to enable each recommended item.
- If you want, I can produce focused change sets for the top 3 critical modules (Key-Vaults, Diagnostic-Settings, Storage-Accounts) to keep changes minimal and reviewable.
